# ======================
# AMCL (NOT USED WITH SLAM, BUT REQUIRED BY NAV2)
# ======================
amcl:
  ros__parameters:
    use_sim_time: false
    # Initial pose (set to your robot's starting position)
    initial_pose:
      x: 0.0
      y: 0.0
      z: 0.0
    initial_pose_a: 0.0  # heading in radians (0 = facing +X)

# ======================
# BT NAVIGATOR
# ======================
bt_navigator:
  ros__parameters:
    use_sim_time: false
    global_frame: map
    robot_base_frame: base_link
    odom_topic: /odom
    default_bt_xml_filename: "navigate_w_replanning_and_recovery.xml"

# ======================
# CONTROLLER SERVER (DWB)
# ======================
controller_server:
  ros__parameters:
    use_sim_time: false
    controller_frequency: 10.0

    controller_plugins: ["FollowPath"]

    FollowPath:
      plugin: "dwb_core::DWBLocalPlanner"

      critics:
        - RotateToGoal
        - Oscillation
        - ObstacleFootprint
        - GoalAlign
        - PathAlign
        - PathDist
        - GoalDist

      GoalAlign.scale: 24.0
      PathAlign.scale: 32.0
      PathDist.scale: 32.0
      GoalDist.scale: 24.0
      ObstacleFootprint.scale: 0.02

    # REQUIRED FIX: Allow rotation-only motion
    min_x_velocity_threshold: 0.0
    min_theta_velocity_threshold: 0.0
    min_linear_velocity: 0.0
    min_angular_velocity: 0.0

    min_vel_x: 0.05
    max_vel_x: 0.30
    max_vel_theta: 1.0
    acc_lim_x: 0.5
    acc_lim_theta: 1.0

# ======================
# PLANNER SERVER (FIXED PLUGIN NAME)
# ======================
planner_server:
  ros__parameters:
    use_sim_time: false
    expected_planner_frequency: 1.0

    planner_plugins: ["GridBased"]

    GridBased:
      plugin: "nav2_navfn_planner::NavfnPlanner"

# ======================
# PROGRESS CHECKER (REQUIRED FIX: Prevents 5-second abort)
# ======================
progress_checker:
  ros__parameters:
    required_movement_radius: 0.05
    movement_time_allowance: 30.0

# ======================
# GOAL CHECKER (REQUIRED FIX: Reduce goal tolerance)
# ======================
goal_checker:
  ros__parameters:
    xy_goal_tolerance: 0.10
    yaw_goal_tolerance: 0.10

# ======================
# GLOBAL COSTMAP
# ======================
global_costmap:
  global_costmap:
    ros__parameters:
      use_sim_time: false

      global_frame: map
      robot_base_frame: base_footprint
      resolution: 0.05
      track_unknown_space: true

      # REQUIRED FIX: Safe footprint to prevent collision thinking
      robot_radius: 0.15
      footprint: "[[0.1,0.1],[0.1,-0.1],[-0.1,-0.1],[-0.1,0.1]]"

      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]

      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"

      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: scan

        scan:
          topic: /scan
          data_type: LaserScan
          max_obstacle_height: 2.0
          clearing: true
          marking: true

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.60

# ======================
# LOCAL COSTMAP
# ======================
local_costmap:
  local_costmap:
    ros__parameters:
      use_sim_time: false

      global_frame: odom
      robot_base_frame: base_footprint
      rolling_window: true

      width: 3
      height: 3
      resolution: 0.05

      # REQUIRED FIX: Safe footprint to prevent collision thinking
      robot_radius: 0.15
      footprint: "[[0.1,0.1],[0.1,-0.1],[-0.1,-0.1],[-0.1,0.1]]"

      plugins: ["obstacle_layer", "inflation_layer"]

      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: scan

        scan:
          topic: /scan
          data_type: LaserScan
          max_obstacle_height: 2.0
          clearing: true
          marking: true

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.50

# ======================
# COLLISION MONITOR (FIXED)
# ======================
collision_monitor:
  ros__parameters:
    use_sim_time: false

    base_frame_id: base_footprint
    odom_frame_id: odom

    observation_sources: ["scan"]

    scan:
      topic: /scan
      enabled: true

    polygons: ["footprint"]

    footprint:
      type: polygon
      points: "[[0.30,0.20],[0.30,-0.20],[-0.30,-0.20],[-0.30,0.20]]"
      action_type: stop

# ======================
# MAP SERVER (REQUIRED EVEN WITH SLAM)
# ======================
map_server:
  ros__parameters:
    use_sim_time: false

# ======================
# RECOVERIES
# ======================
recoveries_server:
  ros__parameters:
    use_sim_time: false

# ======================
# WAYPOINT FOLLOWER
# ======================
waypoint_follower:
  ros__parameters:
    use_sim_time: false

# ======================
# DOCKING (DISABLED CLEANLY)
# ======================
docking_server:
  ros__parameters:
    enabled: false
